Option Explicit

'============================================================
' A列：絶対パス（ファイル/フォルダ）
' B列：結果
'
' 要求仕様：
' - パスが存在しない場合：SKIP（日時も触らない）
' - 作成者(Author)の変更は可能なら行う（Office/PDF）
' - 作成者(Author)の変更に失敗しても、Touch（日時更新）は必ず行う
' - フォルダは Author を持たないので Author はSKIP、Touchは行う
' - Owner は絶対に変更しない
' - 見た目：メイリオ10pt
'============================================================

#If VBA7 Then

'----------------------
' 設定
'----------------------
Private Const SET_LAST_AUTHOR_TOO As Boolean = True
Private Const EXIFTOOL_EXE As String = "exiftool" ' PATHが通っていればOK（フルパスでも可）

'----------------------
' Windows API（ファイル/フォルダ時刻）
'----------------------
Private Type FILETIME
    dwLowDateTime  As Long
    dwHighDateTime As Long
End Type

Private Const FILE_READ_ATTRIBUTES As Long = &H80
Private Const FILE_WRITE_ATTRIBUTES As Long = &H100
Private Const FILE_SHARE_READ  As Long = &H1
Private Const FILE_SHARE_WRITE As Long = &H2
Private Const FILE_SHARE_DELETE As Long = &H4
Private Const OPEN_EXISTING As Long = 3
Private Const FILE_ATTRIBUTE_NORMAL As Long = &H80
Private Const FILE_ATTRIBUTE_DIRECTORY As Long = &H10
Private Const FILE_FLAG_BACKUP_SEMANTICS As Long = &H2000000

Private Const INVALID_HANDLE_VALUE As LongPtr = -1
Private Const INVALID_FILE_ATTRIBUTES As Long = -1

Private Declare PtrSafe Function CreateFileW Lib "kernel32" ( _
    ByVal lpFileName As LongPtr, _
    ByVal dwDesiredAccess As Long, _
    ByVal dwShareMode As Long, _
    ByVal lpSecurityAttributes As LongPtr, _
    ByVal dwCreationDisposition As Long, _
    ByVal dwFlagsAndAttributes As Long, _
    ByVal hTemplateFile As LongPtr _
) As LongPtr

Private Declare PtrSafe Function GetFileTime Lib "kernel32" ( _
    ByVal hFile As LongPtr, _
    ByRef lpCreationTime As FILETIME, _
    ByRef lpLastAccessTime As FILETIME, _
    ByRef lpLastWriteTime As FILETIME _
) As Long

Private Declare PtrSafe Function SetFileTime Lib "kernel32" ( _
    ByVal hFile As LongPtr, _
    ByRef lpCreationTime As FILETIME, _
    ByRef lpLastAccessTime As FILETIME, _
    ByRef lpLastWriteTime As FILETIME _
) As Long

Private Declare PtrSafe Function CloseHandle Lib "kernel32" ( _
    ByVal hObject As LongPtr _
) As Long

Private Declare PtrSafe Sub GetSystemTimeAsFileTime Lib "kernel32" ( _
    ByRef lpSystemTimeAsFileTime As FILETIME _
)

Private Declare PtrSafe Function GetFileAttributesW Lib "kernel32" ( _
    ByVal lpFileName As LongPtr _
) As Long

#End If


'============================================================
' メイン：Author変更（可能なら）＋ Touch（必ず）
'============================================================
Public Sub FixAuthor_AndTouch_FromColA()
#If VBA7 Then
    Dim ws As Worksheet: Set ws = ActiveSheet

    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "A列（A2以降）にパスがありません。", vbInformation
        Exit Sub
    End If

    Dim newAuthor As String
    newAuthor = Trim$(InputBox("設定したい作成者（Author）を入力してください。" & vbCrLf & _
                               "（フォルダはAuthor対象外。存在しないパスはスキップ）", _
                               "Author 一括変更（可能なら）＋ Touch（必ず）"))
    ' Author空でもTouchだけしたいケースがあるので、空は許容
    ' （空なら Author変更はスキップし、Touchのみ実施）

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False

    ApplyFontMeiryo10 ws, lastRow
    ws.Range("A1").Value = "絶対パス"
    ws.Range("B1").Value = "結果"

    ' .xlsm 安全対策：外部ブックを自動化で開く時はマクロ無効
    Dim oldAutoSec As Long
    oldAutoSec = GetExcelAutomationSecurity()
    SetExcelAutomationSecurity 3 ' ForceDisable

    Dim cntOK As Long, cntNG As Long, cntSkip As Long
    Dim r As Long

    For r = 2 To lastRow
        Dim p As String
        p = NormalizePathText(ws.Cells(r, "A").Value)

        If Len(p) = 0 Then
            ws.Cells(r, "B").Value = "SKIP: 空"
            cntSkip = cntSkip + 1
            GoTo ContinueLoop
        End If

        If Not PathExists(p) Then
            ws.Cells(r, "B").Value = "SKIP: 見つかりません"
            cntSkip = cntSkip + 1
            GoTo ContinueLoop
        End If

        Dim isDir As Boolean
        isDir = IsDirectoryPath(p)

        ' 1) まず Author を「可能なら」変更（失敗しても次へ）
        Dim authorTried As Boolean, authorOK As Boolean, authorMsg As String
        authorTried = False
        authorOK = True
        authorMsg = ""

        If Len(newAuthor) > 0 Then
            If isDir Then
                authorTried = False ' フォルダは対象外
            Else
                Dim ext As String
                ext = LCase$(GetExtension(p))

                If IsAuthorSupportedExt(ext) Then
                    authorTried = True
                    authorOK = SetAuthor_ByType(p, ext, newAuthor, authorMsg)
                Else
                    authorTried = False
                End If
            End If
        End If

        ' 2) Touch（日時更新）は「必ず」行う（フォルダも含む）
        Dim touchOK As Boolean, touchMsg As String
        touchMsg = ""
        touchOK = TouchLastWriteTimeToNow(p, touchMsg)

        ' 3) 結果表示
        Dim out As String
        out = ""

        If isDir Then
            out = out & "[DIR] "
        End If

        If authorTried Then
            If authorOK Then
                out = out & "Author=OK; "
            Else
                out = out & "Author=NG(" & authorMsg & "); "
            End If
        Else
            If Len(newAuthor) > 0 And isDir Then
                out = out & "Author=SKIP(フォルダ); "
            ElseIf Len(newAuthor) > 0 Then
                out = out & "Author=SKIP(対象外拡張子); "
            Else
                out = out & "Author=SKIP(未指定); "
            End If
        End If

        If touchOK Then
            out = out & "Touch=OK"
        Else
            out = out & "Touch=NG(" & touchMsg & ")"
        End If

        ws.Cells(r, "B").Value = out

        ' 集計：Touch 成否をベースにする（Touchが目的のため）
        If touchOK Then
            cntOK = cntOK + 1
        Else
            cntNG = cntNG + 1
        End If

ContinueLoop:
    Next r

    ws.Columns("A:B").AutoFit

    ' AutomationSecurity を戻す
    SetExcelAutomationSecurity oldAutoSec

    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True

    MsgBox "完了（Touch結果基準）" & vbCrLf & _
           "OK: " & cntOK & vbCrLf & _
           "NG: " & cntNG & vbCrLf & _
           "SKIP: " & cntSkip, vbInformation
#Else
    MsgBox "このマクロは Windows版 Excel（VBA7）向けです。", vbExclamation
#End If
End Sub


'============================================================
' Touch：最終更新日時(LastWriteTime)を「今」に（ファイル/フォルダ両対応）
'============================================================
Private Function TouchLastWriteTimeToNow(ByVal path As String, ByRef errMsg As String) As Boolean
#If VBA7 Then
    On Error GoTo EH

    Dim pApi As String
    pApi = NormalizeLongPath(path)

    Dim attr As Long
    attr = GetFileAttributesW(StrPtr(pApi))
    If attr = INVALID_FILE_ATTRIBUTES Then
        errMsg = "見つかりません"
        TouchLastWriteTimeToNow = False
        Exit Function
    End If

    Dim isDir As Boolean
    isDir = ((attr And FILE_ATTRIBUTE_DIRECTORY) <> 0)

    Dim flags As Long
    flags = IIf(isDir, FILE_FLAG_BACKUP_SEMANTICS, FILE_ATTRIBUTE_NORMAL)

    Dim h As LongPtr
    h = CreateFileW(StrPtr(pApi), FILE_WRITE_ATTRIBUTES, FILE_SHARE_READ Or FILE_SHARE_WRITE Or FILE_SHARE_DELETE, 0, OPEN_EXISTING, flags, 0)
    If h = INVALID_HANDLE_VALUE Then
        errMsg = "開けません（権限/共有）"
        TouchLastWriteTimeToNow = False
        Exit Function
    End If

    ' 現在時刻
    Dim ftNow As FILETIME
    GetSystemTimeAsFileTime ftNow

    ' Create/Access はそのまま、Writeだけ更新したいが SetFileTime は全部必要。
    ' なので現在の Create/Access を取ってから Write を今にする。
    Dim ftC As FILETIME, ftA As FILETIME, ftW As FILETIME
    If GetFileTime(h, ftC, ftA, ftW) = 0 Then
        CloseHandle h
        errMsg = "GetFileTime失敗"
        TouchLastWriteTimeToNow = False
        Exit Function
    End If

    Dim ret As Long
    ret = SetFileTime(h, ftC, ftA, ftNow)

    CloseHandle h

    If ret = 0 Then
        errMsg = "SetFileTime失敗"
        TouchLastWriteTimeToNow = False
    Else
        TouchLastWriteTimeToNow = True
    End If
    Exit Function

EH:
    errMsg = "例外: " & Err.Description
    TouchLastWriteTimeToNow = False
#Else
    errMsg = "VBA7未対応"
    TouchLastWriteTimeToNow = False
#End If
End Function


'============================================================
' Author変更：拡張子別
'============================================================
Private Function SetAuthor_ByType(ByVal fullPath As String, ByVal ext As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    On Error GoTo EH

    Select Case ext
        Case "xlsx", "xlsm", "xlsb", "xls"
            SetAuthor_ByType = SetAuthor_Excel(fullPath, newAuthor, errMsg)
            Exit Function
        Case "docx", "docm", "doc"
            SetAuthor_ByType = SetAuthor_Word(fullPath, newAuthor, errMsg)
            Exit Function
        Case "pptx", "pptm", "ppt"
            SetAuthor_ByType = SetAuthor_PowerPoint(fullPath, newAuthor, errMsg)
            Exit Function
        Case "pdf"
            SetAuthor_ByType = SetAuthor_PDF_ExifTool(fullPath, newAuthor, errMsg)
            Exit Function
    End Select

    errMsg = "未対応拡張子"
    SetAuthor_ByType = False
    Exit Function

EH:
    errMsg = "例外: " & Err.Description
    SetAuthor_ByType = False
End Function

Private Function IsAuthorSupportedExt(ByVal ext As String) As Boolean
    Select Case ext
        Case "xlsx", "xlsm", "xlsb", "xls", "docx", "docm", "doc", "pptx", "pptm", "ppt", "pdf"
            IsAuthorSupportedExt = True
        Case Else
            IsAuthorSupportedExt = False
    End Select
End Function


'============================================================
' Excel：Author変更（開いているブックは事故防止でNG）
'============================================================
Private Function SetAuthor_Excel(ByVal path As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    On Error GoTo EH

    If IsWorkbookAlreadyOpen(path) Then
        errMsg = "開いているため変更不可（事故防止）"
        SetAuthor_Excel = False
        Exit Function
    End If

    Dim wb As Workbook
    Set wb = Application.Workbooks.Open(Filename:=path, UpdateLinks:=0, ReadOnly:=False, AddToMru:=False)

    On Error Resume Next
    wb.BuiltinDocumentProperties("Author").Value = newAuthor
    If SET_LAST_AUTHOR_TOO Then wb.BuiltinDocumentProperties("Last Author").Value = newAuthor
    If Err.Number <> 0 Then
        errMsg = "Author設定失敗（保護/権限/形式）"
        Err.Clear
        On Error GoTo EH
        wb.Close SaveChanges:=False
        SetAuthor_Excel = False
        Exit Function
    End If
    On Error GoTo EH

    wb.Save
    wb.Close SaveChanges:=False

    SetAuthor_Excel = True
    Exit Function

EH:
    errMsg = "Excel失敗: " & Err.Description
    On Error Resume Next
    If Not wb Is Nothing Then wb.Close SaveChanges:=False
    On Error GoTo 0
    SetAuthor_Excel = False
End Function

Private Function IsWorkbookAlreadyOpen(ByVal fullPath As String) As Boolean
    Dim w As Workbook
    For Each w In Application.Workbooks
        On Error Resume Next
        If StrComp(w.FullName, fullPath, vbTextCompare) = 0 Then
            IsWorkbookAlreadyOpen = True
            Exit Function
        End If
        On Error GoTo 0
    Next w
    IsWorkbookAlreadyOpen = False
End Function


'============================================================
' Word：Author変更（late binding）
'============================================================
Private Function SetAuthor_Word(ByVal path As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    On Error GoTo EH

    Dim wdApp As Object, doc As Object
    Set wdApp = CreateObject("Word.Application")
    wdApp.Visible = False
    On Error Resume Next
    wdApp.DisplayAlerts = 0
    wdApp.AutomationSecurity = 3 ' ForceDisable
    On Error GoTo EH

    Set doc = wdApp.Documents.Open(path, False, False, False, "", "", False)

    On Error Resume Next
    doc.BuiltInDocumentProperties("Author").Value = newAuthor
    If SET_LAST_AUTHOR_TOO Then doc.BuiltInDocumentProperties("Last Author").Value = newAuthor
    If Err.Number <> 0 Then
        errMsg = "Author設定失敗（保護/権限/形式）"
        Err.Clear
        On Error GoTo EH
        doc.Close False
        wdApp.Quit
        SetAuthor_Word = False
        Exit Function
    End If
    On Error GoTo EH

    doc.Save
    doc.Close False
    wdApp.Quit

    SetAuthor_Word = True
    Exit Function

EH:
    errMsg = "Word失敗: " & Err.Description
    On Error Resume Next
    If Not doc Is Nothing Then doc.Close False
    If Not wdApp Is Nothing Then wdApp.Quit
    On Error GoTo 0
    SetAuthor_Word = False
End Function


'============================================================
' PowerPoint：Author変更（late binding）
'============================================================
Private Function SetAuthor_PowerPoint(ByVal path As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    On Error GoTo EH

    Dim ppApp As Object, pres As Object
    Set ppApp = CreateObject("PowerPoint.Application")
    On Error Resume Next
    ppApp.DisplayAlerts = 1
    ppApp.AutomationSecurity = 3
    On Error GoTo EH

    Set pres = ppApp.Presentations.Open(path, False, False, 0)

    On Error Resume Next
    pres.BuiltInDocumentProperties("Author").Value = newAuthor
    If SET_LAST_AUTHOR_TOO Then pres.BuiltInDocumentProperties("Last Author").Value = newAuthor
    If Err.Number <> 0 Then
        errMsg = "Author設定失敗（保護/権限/形式）"
        Err.Clear
        On Error GoTo EH
        pres.Close
        ppApp.Quit
        SetAuthor_PowerPoint = False
        Exit Function
    End If
    On Error GoTo EH

    pres.Save
    pres.Close
    ppApp.Quit

    SetAuthor_PowerPoint = True
    Exit Function

EH:
    errMsg = "PowerPoint失敗: " & Err.Description
    On Error Resume Next
    If Not pres Is Nothing Then pres.Close
    If Not ppApp Is Nothing Then ppApp.Quit
    On Error GoTo 0
    SetAuthor_PowerPoint = False
End Function


'============================================================
' PDF：ExifTool がある場合のみ Author変更
'============================================================
Private Function SetAuthor_PDF_ExifTool(ByVal path As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    Dim cmd As String, rc As Long

    cmd = "cmd /c " & QuoteForCmd(EXIFTOOL_EXE) & _
          " -overwrite_original " & _
          " -Author=" & QuoteForCmd(newAuthor) & _
          " -Creator=" & QuoteForCmd(newAuthor) & _
          " -XMP-dc:Creator=" & QuoteForCmd(newAuthor) & _
          " " & QuoteForCmd(path)

    rc = RunHidden(cmd)

    If rc <> 0 Then
        errMsg = "ExifTool未導入/失敗（rc=" & CStr(rc) & "）"
        SetAuthor_PDF_ExifTool = False
    Else
        SetAuthor_PDF_ExifTool = True
    End If
End Function


'============================================================
' 便利関数
'============================================================
Private Function PathExists(ByVal path As String) As Boolean
    Dim pApi As String
    pApi = NormalizeLongPath(path)
    PathExists = (GetFileAttributesW(StrPtr(pApi)) <> INVALID_FILE_ATTRIBUTES)
End Function

Private Function IsDirectoryPath(ByVal path As String) As Boolean
    Dim pApi As String
    pApi = NormalizeLongPath(path)

    Dim attr As Long
    attr = GetFileAttributesW(StrPtr(pApi))
    If attr = INVALID_FILE_ATTRIBUTES Then
        IsDirectoryPath = False
    Else
        IsDirectoryPath = ((attr And FILE_ATTRIBUTE_DIRECTORY) <> 0)
    End If
End Function

Private Sub ApplyFontMeiryo10(ByVal ws As Worksheet, ByVal lastRow As Long)
    Dim r As Long
    r = Application.WorksheetFunction.Max(2, lastRow)
    With ws.Range("A1:B" & r).Font
        .Name = "メイリオ"
        .Size = 10
    End With
End Sub

Private Function NormalizePathText(ByVal v As Variant) As String
    Dim t As String
    t = CStr(v)
    t = Replace(t, ChrW(&H3000), " ")
    On Error Resume Next
    t = Application.WorksheetFunction.Trim(t)
    On Error GoTo 0
    NormalizePathText = t
End Function

Private Function GetExtension(ByVal path As String) As String
    Dim p As Long
    p = InStrRev(path, ".")
    If p <= 0 Then
        GetExtension = ""
    Else
        GetExtension = Mid$(path, p + 1)
    End If
End Function

Private Function NormalizeLongPath(ByVal p As String) As String
    Dim s As String
    s = p

    If Left$(s, 4) = "\\?\" Then
        NormalizeLongPath = s
        Exit Function
    End If

    If Len(s) < 240 Then
        NormalizeLongPath = s
        Exit Function
    End If

    If Left$(s, 2) = "\\" Then
        NormalizeLongPath = "\\?\UNC\" & Mid$(s, 3)
        Exit Function
    End If

    NormalizeLongPath = "\\?\" & s
End Function

Private Function GetExcelAutomationSecurity() As Long
    On Error Resume Next
    GetExcelAutomationSecurity = Application.AutomationSecurity
    On Error GoTo 0
End Function

Private Sub SetExcelAutomationSecurity(ByVal v As Long)
    On Error Resume Next
    Application.AutomationSecurity = v
    On Error GoTo 0
End Sub

Private Function QuoteForCmd(ByVal s As String) As String
    QuoteForCmd = """" & Replace(s, """", """""") & """"
End Function

Private Function RunHidden(ByVal cmd As String) As Long
    Dim sh As Object
    Set sh = CreateObject("WScript.Shell")
    RunHidden = sh.Run(cmd, 0, True)
End Function

#Else
' VBA7 以外は何もしない（コンパイルエラー回避）
#End If
