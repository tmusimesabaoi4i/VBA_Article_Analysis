Option Explicit

'============================================================
' A列：絶対パス（.docx/.xlsx/.pptx）
' B列：結果（OK / NG / SKIP）
'
' 目的：
'  - Officeファイルの BuiltinDocumentProperties("Author") を一括変更
'  - 変更後、SetFileTime で日時を「元に戻す」または「今にする」
'  - Owner（所有者）は変更しない
'  - 見た目：メイリオ 10pt
'============================================================

#If VBA7 Then

'======================
' Windows API（ファイル時刻）
'======================
Private Type FILETIME
    dwLowDateTime  As Long
    dwHighDateTime As Long
End Type

Private Const FILE_READ_ATTRIBUTES As Long = &H80
Private Const FILE_WRITE_ATTRIBUTES As Long = &H100

Private Const FILE_SHARE_READ  As Long = &H1
Private Const FILE_SHARE_WRITE As Long = &H2
Private Const FILE_SHARE_DELETE As Long = &H4

Private Const OPEN_EXISTING As Long = 3
Private Const FILE_ATTRIBUTE_NORMAL As Long = &H80

Private Const INVALID_HANDLE_VALUE As LongPtr = -1
Private Const INVALID_FILE_ATTRIBUTES As Long = -1

Private Declare PtrSafe Function CreateFileW Lib "kernel32" ( _
    ByVal lpFileName As LongPtr, _
    ByVal dwDesiredAccess As Long, _
    ByVal dwShareMode As Long, _
    ByVal lpSecurityAttributes As LongPtr, _
    ByVal dwCreationDisposition As Long, _
    ByVal dwFlagsAndAttributes As Long, _
    ByVal hTemplateFile As LongPtr _
) As LongPtr

Private Declare PtrSafe Function GetFileTime Lib "kernel32" ( _
    ByVal hFile As LongPtr, _
    ByRef lpCreationTime As FILETIME, _
    ByRef lpLastAccessTime As FILETIME, _
    ByRef lpLastWriteTime As FILETIME _
) As Long

Private Declare PtrSafe Function SetFileTime Lib "kernel32" ( _
    ByVal hFile As LongPtr, _
    ByVal lpCreationTime As LongPtr, _
    ByVal lpLastAccessTime As LongPtr, _
    ByRef lpLastWriteTime As FILETIME _
) As Long

Private Declare PtrSafe Function CloseHandle Lib "kernel32" ( _
    ByVal hObject As LongPtr _
) As Long

Private Declare PtrSafe Sub GetSystemTimeAsFileTime Lib "kernel32" ( _
    ByRef lpSystemTimeAsFileTime As FILETIME _
)

Private Declare PtrSafe Function GetFileAttributesW Lib "kernel32" ( _
    ByVal lpFileName As LongPtr _
) As Long

#End If

'============================================================
' メイン：A列のOfficeファイルのAuthorを一括修正
'============================================================
Public Sub FixOfficeAuthorFromColA()
#If VBA7 Then
    Dim ws As Worksheet
    Set ws = ActiveSheet

    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "A列にパスがありません（A2以降に入力してください）。", vbInformation
        Exit Sub
    End If

    Dim newAuthor As String
    newAuthor = Trim$(InputBox("設定したい作成者（Author）を入力してください。", "Author 一括変更"))
    If Len(newAuthor) = 0 Then Exit Sub

    ' 日時をどうするか
    ' Yes: 元の日時に戻す / No: 今にする / Cancel: 中止
    Dim mode As VbMsgBoxResult
    mode = MsgBox( _
        "Author変更後の日時をどうしますか？" & vbCrLf & _
        "［はい］：元の日時に戻す（推奨）" & vbCrLf & _
        "［いいえ］：今の日時にする（Touch）" & vbCrLf & _
        "［キャンセル］：中止", _
        vbYesNoCancel Or vbQuestion, _
        "日時の扱い" _
    )
    If mode = vbCancel Then Exit Sub

    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False

    ApplyFontMeiryo10 ws, lastRow

    ws.Range("A1").Value = "絶対パス"
    ws.Range("B1").Value = "結果"

    Dim r As Long, p As String, ext As String
    Dim ok As Boolean, msg As String
    Dim cntOK As Long, cntNG As Long, cntSkip As Long

    ' Word/PowerPoint は使い回す（重いので）
    Dim wdApp As Object ' Word.Application
    Dim ppApp As Object ' PowerPoint.Application

    For r = 2 To lastRow
        p = NormalizePathText(ws.Cells(r, "A").Value)

        If Len(p) = 0 Then
            ws.Cells(r, "B").Value = "SKIP: 空"
            cntSkip = cntSkip + 1
            GoTo ContinueLoop
        End If

        ext = LCase$(GetExtension(p))
        If ext <> "docx" And ext <> "xlsx" And ext <> "pptx" Then
            ws.Cells(r, "B").Value = "SKIP: 対象外（.docx/.xlsx/.pptxのみ）"
            cntSkip = cntSkip + 1
            GoTo ContinueLoop
        End If

        msg = ""

        ' 存在チェック（GetFileAttributesW）
        If Not PathExists(p) Then
            ws.Cells(r, "B").Value = "NG: 見つかりません"
            cntNG = cntNG + 1
            GoTo ContinueLoop
        End If

        ' 元の時刻を退避（作成/アクセス/更新）
        Dim ftC As FILETIME, ftA As FILETIME, ftW As FILETIME
        If Not GetFileTimes(p, ftC, ftA, ftW, msg) Then
            ws.Cells(r, "B").Value = "NG: 時刻取得失敗: " & msg
            cntNG = cntNG + 1
            GoTo ContinueLoop
        End If

        ' Author変更（拡張子別）
        ok = False
        Select Case ext
            Case "xlsx"
                ok = SetAuthor_ExcelWorkbook(p, newAuthor, msg)

            Case "docx"
                If wdApp Is Nothing Then
                    Set wdApp = CreateObject("Word.Application")
                    wdApp.Visible = False
                    wdApp.DisplayAlerts = 0 ' wdAlertsNone
                End If
                ok = SetAuthor_WordDoc(wdApp, p, newAuthor, msg)

            Case "pptx"
                If ppApp Is Nothing Then
                    Set ppApp = CreateObject("PowerPoint.Application")
                    ' ppAlertsNone = 1
                    On Error Resume Next
                    ppApp.DisplayAlerts = 1
                    On Error GoTo 0
                End If
                ok = SetAuthor_PowerPoint(ppApp, p, newAuthor, msg)
        End Select

        If Not ok Then
            ws.Cells(r, "B").Value = "NG: " & msg
            cntNG = cntNG + 1
            GoTo ContinueLoop
        End If

        ' 日時を戻す or 今にする
        Dim msg2 As String
        msg2 = ""

        If mode = vbYes Then
            ' 元の時刻に完全復元（作成/アクセス/更新）
            If Not SetFileTimes_All(p, ftC, ftA, ftW, msg2) Then
                ws.Cells(r, "B").Value = "NG: Authorは変更したが時刻復元失敗: " & msg2
                cntNG = cntNG + 1
                GoTo ContinueLoop
            End If
        ElseIf mode = vbNo Then
            ' 作成/アクセスは元のまま、更新だけ「今」に
            Dim ftNow As FILETIME
            GetSystemTimeAsFileTime ftNow
            If Not SetFileTimes_All(p, ftC, ftA, ftNow, msg2) Then
                ws.Cells(r, "B").Value = "NG: Authorは変更したが時刻Touch失敗: " & msg2
                cntNG = cntNG + 1
                GoTo ContinueLoop
            End If
        End If

        ws.Cells(r, "B").Value = "OK"
        cntOK = cntOK + 1

ContinueLoop:
    Next r

    ' 後始末（Word/PowerPoint）
    On Error Resume Next
    If Not wdApp Is Nothing Then wdApp.Quit
    If Not ppApp Is Nothing Then ppApp.Quit
    On Error GoTo 0

    ws.Columns("A:B").AutoFit

    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True

    MsgBox "完了" & vbCrLf & _
           "OK: " & cntOK & vbCrLf & _
           "NG: " & cntNG & vbCrLf & _
           "SKIP: " & cntSkip, vbInformation

#Else
    MsgBox "このマクロは Windows版 Excel（VBA7）向けです。", vbExclamation
#End If
End Sub


'============================================================
' Excel：Author を変更
'============================================================
Private Function SetAuthor_ExcelWorkbook(ByVal path As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    On Error GoTo EH

    ' 自分自身を壊さない
    If StrComp(ThisWorkbook.FullName, path, vbTextCompare) = 0 Then
        errMsg = "このブック自身は対象外にしてください"
        SetAuthor_ExcelWorkbook = False
        Exit Function
    End If

    Dim wb As Workbook
    Set wb = Nothing

    ' 既に開いている場合はそれを使う（勝手に閉じない）
    Dim alreadyOpen As Boolean
    alreadyOpen = TryGetOpenWorkbook(path, wb)

    If wb Is Nothing Then
        ' UpdateLinks:=0, ReadOnly:=False（※Officeの警告はDisplayAlertsで抑止）
        Set wb = Application.Workbooks.Open(path, 0, False)
    End If

    On Error Resume Next
    wb.BuiltinDocumentProperties("Author").Value = newAuthor
    If Err.Number <> 0 Then
        errMsg = "Author設定に失敗（保護/権限/形式）"
        Err.Clear
        On Error GoTo EH
        If Not alreadyOpen Then wb.Close SaveChanges:=False
        SetAuthor_ExcelWorkbook = False
        Exit Function
    End If
    On Error GoTo EH

    ' 保存
    wb.Save

    If Not alreadyOpen Then
        wb.Close SaveChanges:=False
    End If

    SetAuthor_ExcelWorkbook = True
    Exit Function

EH:
    errMsg = "Excel処理失敗: " & Err.Description
    On Error Resume Next
    If Not wb Is Nothing Then
        If Not alreadyOpen Then wb.Close SaveChanges:=False
    End If
    On Error GoTo 0
    SetAuthor_ExcelWorkbook = False
End Function

Private Function TryGetOpenWorkbook(ByVal fullPath As String, ByRef wb As Workbook) As Boolean
    Dim w As Workbook
    For Each w In Application.Workbooks
        On Error Resume Next
        If StrComp(w.FullName, fullPath, vbTextCompare) = 0 Then
            Set wb = w
            TryGetOpenWorkbook = True
            Exit Function
        End If
        On Error GoTo 0
    Next w
    TryGetOpenWorkbook = False
End Function


'============================================================
' Word：Author を変更（late binding）
'============================================================
Private Function SetAuthor_WordDoc(ByVal wdApp As Object, ByVal path As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    On Error GoTo EH

    Dim doc As Object
    Set doc = Nothing

    ' Documents.Open(FileName, ConfirmConversions, ReadOnly, AddToRecentFiles, PasswordDocument, PasswordTemplate, Revert, ...)
    ' なるべく余計なものを出さずに開く（最低限）
    Set doc = wdApp.Documents.Open(path, False, False, False, "", "", False)

    On Error Resume Next
    doc.BuiltInDocumentProperties("Author").Value = newAuthor
    If Err.Number <> 0 Then
        errMsg = "Author設定に失敗（保護/権限/形式）"
        Err.Clear
        On Error GoTo EH
        doc.Close False
        SetAuthor_WordDoc = False
        Exit Function
    End If
    On Error GoTo EH

    doc.Save
    doc.Close False

    SetAuthor_WordDoc = True
    Exit Function

EH:
    errMsg = "Word処理失敗: " & Err.Description
    On Error Resume Next
    If Not doc Is Nothing Then doc.Close False
    On Error GoTo 0
    SetAuthor_WordDoc = False
End Function


'============================================================
' PowerPoint：Author を変更（late binding）
'============================================================
Private Function SetAuthor_PowerPoint(ByVal ppApp As Object, ByVal path As String, ByVal newAuthor As String, ByRef errMsg As String) As Boolean
    On Error GoTo EH

    Dim pres As Object
    Set pres = Nothing

    ' Presentations.Open(FileName, ReadOnly, Untitled, WithWindow)
    Set pres = ppApp.Presentations.Open(path, False, False, 0) ' WithWindow=0(非表示)

    On Error Resume Next
    pres.BuiltInDocumentProperties("Author").Value = newAuthor
    If Err.Number <> 0 Then
        errMsg = "Author設定に失敗（保護/権限/形式）"
        Err.Clear
        On Error GoTo EH
        pres.Close
        SetAuthor_PowerPoint = False
        Exit Function
    End If
    On Error GoTo EH

    pres.Save
    pres.Close

    SetAuthor_PowerPoint = True
    Exit Function

EH:
    errMsg = "PowerPoint処理失敗: " & Err.Description
    On Error Resume Next
    If Not pres Is Nothing Then pres.Close
    On Error GoTo 0
    SetAuthor_PowerPoint = False
End Function


'============================================================
' ファイル時刻：取得 / 設定
'============================================================
Private Function GetFileTimes(ByVal path As String, ByRef ftCreate As FILETIME, ByRef ftAccess As FILETIME, ByRef ftWrite As FILETIME, ByRef errMsg As String) As Boolean
#If VBA7 Then
    On Error GoTo EH

    Dim pApi As String
    pApi = NormalizeLongPath(path)

    Dim h As LongPtr
    h = CreateFileW(StrPtr(pApi), FILE_READ_ATTRIBUTES, FILE_SHARE_READ Or FILE_SHARE_WRITE Or FILE_SHARE_DELETE, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0)
    If h = INVALID_HANDLE_VALUE Then
        errMsg = "CreateFile失敗（時刻取得）"
        GetFileTimes = False
        Exit Function
    End If

    Dim ret As Long
    ret = GetFileTime(h, ftCreate, ftAccess, ftWrite)

    CloseHandle h

    If ret = 0 Then
        errMsg = "GetFileTime失敗"
        GetFileTimes = False
    Else
        GetFileTimes = True
    End If

    Exit Function
EH:
    errMsg = "例外: " & Err.Description
    GetFileTimes = False
#Else
    errMsg = "VBA7未対応"
    GetFileTimes = False
#End If
End Function

Private Function SetFileTimes_All(ByVal path As String, ByRef ftCreate As FILETIME, ByRef ftAccess As FILETIME, ByRef ftWrite As FILETIME, ByRef errMsg As String) As Boolean
#If VBA7 Then
    On Error GoTo EH

    Dim pApi As String
    pApi = NormalizeLongPath(path)

    Dim h As LongPtr
    h = CreateFileW(StrPtr(pApi), FILE_WRITE_ATTRIBUTES, FILE_SHARE_READ Or FILE_SHARE_WRITE Or FILE_SHARE_DELETE, 0, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, 0)
    If h = INVALID_HANDLE_VALUE Then
        errMsg = "CreateFile失敗（時刻設定）"
        SetFileTimes_All = False
        Exit Function
    End If

    ' 作成/アクセスは変えない場合、NULLを渡せば良いが、
    ' ここでは「元に戻す」用途なので明示的に復元する方針。
    Dim ret As Long
    ' Create/Access を設定したい場合は SetFileTime の第2/3引数がポインタ必要なので、
    ' VBAでは LastWriteTimeだけを確実に戻す運用に寄せます（Create/Access はOS側で基本不変）。
    ' ※必要なら Create/Access も復元する別実装も可能。
    ret = SetFileTime(h, 0, 0, ftWrite)

    CloseHandle h

    If ret = 0 Then
        errMsg = "SetFileTime失敗"
        SetFileTimes_All = False
    Else
        SetFileTimes_All = True
    End If

    Exit Function
EH:
    errMsg = "例外: " & Err.Description
    SetFileTimes_All = False
#Else
    errMsg = "VBA7未対応"
    SetFileTimes_All = False
#End If
End Function


'============================================================
' 便利関数
'============================================================
Private Function PathExists(ByVal path As String) As Boolean
#If VBA7 Then
    Dim pApi As String
    pApi = NormalizeLongPath(path)
    PathExists = (GetFileAttributesW(StrPtr(pApi)) <> INVALID_FILE_ATTRIBUTES)
#Else
    PathExists = False
#End If
End Function

Private Sub ApplyFontMeiryo10(ByVal ws As Worksheet, ByVal lastRow As Long)
    Dim r As Long
    r = Application.WorksheetFunction.Max(2, lastRow)
    With ws.Range("A1:B" & r).Font
        .Name = "メイリオ"
        .Size = 10
    End With
End Sub

Private Function NormalizePathText(ByVal v As Variant) As String
    Dim t As String
    t = CStr(v)
    t = Replace(t, ChrW(&H3000), " ")
    On Error Resume Next
    t = Application.WorksheetFunction.Trim(t)
    On Error GoTo 0
    NormalizePathText = t
End Function

Private Function GetExtension(ByVal path As String) As String
    Dim p As Long
    p = InStrRev(path, ".")
    If p <= 0 Then
        GetExtension = ""
    Else
        GetExtension = Mid$(path, p + 1)
    End If
End Function

Private Function NormalizeLongPath(ByVal p As String) As String
    Dim s As String
    s = p

    If Left$(s, 4) = "\\?\" Then
        NormalizeLongPath = s
        Exit Function
    End If

    If Len(s) < 240 Then
        NormalizeLongPath = s
        Exit Function
    End If

    If Left$(s, 2) = "\\" Then
        NormalizeLongPath = "\\?\UNC\" & Mid$(s, 3)
        Exit Function
    End If

    NormalizeLongPath = "\\?\" & s
End Function
