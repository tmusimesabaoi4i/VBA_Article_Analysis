Option Explicit

' ======================================================================
' 名簿統合マクロ
' ======================================================================

' -------------------------------
' ★シート名（必要に応じて変更）
' -------------------------------
Private Const SH_BOSS  As String = "上司名簿"
Private Const SH_ORDER As String = "年次順"
Private Const SH_MAIL  As String = "システム上の氏名vsメールアドレス"
Private Const SH_DISP  As String = "氏名vs名簿上の名前"
Private Const SH_OUT   As String = "統合名簿"

' -------------------------------
' ★出力ヘッダー（固定）
' -------------------------------
Private OUTPUT_HEADERS As Variant

' ======================================================================
' 公開：この1本だけ実行
' ======================================================================
Public Sub 名簿統合_実行()
  On Error GoTo EH

  Application.ScreenUpdating = False
  Application.EnableEvents = False
  Application.DisplayAlerts = False

  OUTPUT_HEADERS = Array( _
    "コード", "氏名", "役職", "所属", "グループ", _
    "名簿上の名前", "座席予約簿上の名前", "システム上の氏名", "メールアドレス", "特技懇" _
  )

  Dim wb As Workbook: Set wb = ThisWorkbook

  ' --- シートを必ず用意（無ければ作る）
  Dim wsBoss As Worksheet, wsOrder As Worksheet, wsMail As Worksheet, wsDisp As Worksheet, wsOut As Worksheet
  Set wsBoss = GetOrCreateSheet(wb, SH_BOSS)
  Set wsOrder = GetOrCreateSheet(wb, SH_ORDER)
  Set wsMail = GetOrCreateSheet(wb, SH_MAIL)
  Set wsDisp = GetOrCreateSheet(wb, SH_DISP)
  Set wsOut = GetOrCreateSheet(wb, SH_OUT)

  ' --- データが無い場合でも「初期化（テンプレ整形）」を実施する
  InitTemplateBoss wsBoss
  InitTemplateOrder wsOrder
  InitTemplateMail wsMail
  InitTemplateDisp wsDisp
  InitTemplateOut wsOut, OUTPUT_HEADERS

  ' --- 体裁統一（全シート）
  ApplyStandardSheetFormat wsBoss
  ApplyStandardSheetFormat wsOrder
  ApplyStandardSheetFormat wsMail
  ApplyStandardSheetFormat wsDisp
  ApplyStandardSheetFormat wsOut

  ' --- 【データなし判定】上司名簿に実データが無ければ終了（仕様）
  If Not HasBossData(wsBoss) Then
    ' 統合名簿はテンプレのままフィルタ付与
    ApplyAutoFilterSafe wsOut, 1, UBound(OUTPUT_HEADERS) + 1, 200
    MsgBox "データなし（上司名簿に実データがありません）。" & vbCrLf & _
           "ヘッダー整形／枠／フォント等の初期化のみ実施しました。", vbInformation
    GoTo FIN
  End If

  ' ===========================
  ' ここから統合処理（データあり）
  ' ===========================

  ' --- 上司名簿：必須列位置をヘッダーから特定（列は増減してOK）
  Dim bossHeaderRow As Long
  Dim colCode As Long, colName As Long, colSys As Long, colDept As Long, colGroup As Long, colRole As Long

  bossHeaderRow = FindHeaderRow(wsBoss, Array("コード", "Code", "ID"))
  If bossHeaderRow = 0 Then
    ApplyAutoFilterSafe wsOut, 1, UBound(OUTPUT_HEADERS) + 1, 200
    MsgBox "データなし（上司名簿のヘッダー「コード」が見つかりません）。" & vbCrLf & _
           "ヘッダー整形／枠／フォント等の初期化のみ実施しました。", vbInformation
    GoTo FIN
  End If

  colCode = FindColInRow(wsBoss, bossHeaderRow, Array("コード", "Code", "ID"))
  colName = FindColInRow(wsBoss, bossHeaderRow, Array("氏名", "名前", "Name"))
  colSys = FindColInRow(wsBoss, bossHeaderRow, Array("システム上の氏名", "システム氏名", "SystemName", "system"))
  colDept = FindColInRow(wsBoss, bossHeaderRow, Array("所属", "部署", "部門"))
  colGroup = FindColInRow(wsBoss, bossHeaderRow, Array("グループ", "Group"))
  colRole = FindColInRow(wsBoss, bossHeaderRow, Array("役職", "職位", "Role"))

  If colName = 0 Or colSys = 0 Or colDept = 0 Or colGroup = 0 Or colRole = 0 Or colCode = 0 Then
    ApplyAutoFilterSafe wsOut, 1, UBound(OUTPUT_HEADERS) + 1, 200
    MsgBox "上司名簿の必須ヘッダー（氏名/システム上の氏名/所属/グループ/役職/コード）が揃っていません。" & vbCrLf & _
           "初期化のみ実施して終了します。", vbExclamation
    GoTo FIN
  End If

  ' --- 上司名簿をコードキーで読み込み（人の正はここ）
  Dim dictBoss As Object: Set dictBoss = CreateObject("Scripting.Dictionary") ' key: code, value: rec(1..5)
  Dim bossCodesInSheetOrder As Collection: Set bossCodesInSheetOrder = New Collection
  ReadBossRoster wsBoss, bossHeaderRow, colCode, colName, colSys, colDept, colGroup, colRole, dictBoss, bossCodesInSheetOrder

  ' --- system vs メール（key: システム上の氏名）
  Dim dictMail As Object: Set dictMail = CreateObject("Scripting.Dictionary")
  ReadSimpleMap wsMail, Array("システム上の氏名", "SystemName", "system"), Array("メールアドレス", "メール", "Mail"), dictMail

  ' --- 氏名 vs 名簿上の名前（key: 氏名）→ 名簿上の名前として利用
  Dim dictRosterName As Object: Set dictRosterName = CreateObject("Scripting.Dictionary")
  ReadSimpleMap wsDisp, Array("氏名", "名前", "Name"), Array("名簿上の名前", "名簿上の名前", "表示名"), dictRosterName

  ' --- 年次順（コードは100%ある前提）：上司名簿に存在するコードだけ順序として採用
  Dim orderCodes As Collection: Set orderCodes = New Collection
  ReadOrderCodes wsOrder, dictBoss, orderCodes

  ' --- 出力シートをクリアしてヘッダー再出力
  wsOut.Cells.Clear
  InitTemplateOut wsOut, OUTPUT_HEADERS
  ApplyStandardSheetFormat wsOut

  ' --- 出力行生成：年次順→残り（上司名簿の元順）
  Dim used As Object: Set used = CreateObject("Scripting.Dictionary")
  Dim rOut As Long: rOut = 2

  Dim code As Variant
  For Each code In orderCodes
    If dictBoss.Exists(code) Then
      If Not used.Exists(CStr(code)) Then
        WriteOne wsOut, rOut, CStr(code), dictBoss, dictRosterName, dictMail
        used.Add CStr(code), True
        rOut = rOut + 1
      End If
    End If
  Next

  ' 年次順に出てこない在籍者（上司名簿にいるがorderにいない）を末尾へ
  Dim c As Variant
  For Each c In bossCodesInSheetOrder
    If dictBoss.Exists(c) Then
      If Not used.Exists(CStr(c)) Then
        WriteOne wsOut, rOut, CStr(c), dictBoss, dictRosterName, dictMail
        used.Add CStr(c), True
        rOut = rOut + 1
      End If
    End If
  Next

  ' --- 特技懇：〇/×のプルダウン（10列目）
  If rOut > 2 Then
    ApplyMaruBatsuDropdown wsOut, 2, rOut - 1, 10
  Else
    ApplyMaruBatsuDropdown wsOut, 2, 200, 10
  End If

  ' --- ヘッダーフィルタ（データ範囲に付与）
  Dim lastDataRow As Long
  lastDataRow = IIf(rOut > 2, rOut - 1, 200)
  ApplyAutoFilterSafe wsOut, 1, UBound(OUTPUT_HEADERS) + 1, lastDataRow

  ' --- 見やすさ（最低限）
  wsOut.Columns.AutoFit
  wsOut.Columns(9).ColumnWidth = 28 ' メール
  wsOut.Columns(7).ColumnWidth = 22 ' 座席予約簿上の名前
  wsOut.Columns(6).ColumnWidth = 16 ' 名簿上の名前
  wsOut.Columns(8).ColumnWidth = 18 ' システム上の氏名

  MsgBox "統合名簿を生成しました: " & SH_OUT, vbInformation

FIN:
  Application.DisplayAlerts = True
  Application.EnableEvents = True
  Application.ScreenUpdating = True
  Exit Sub

EH:
  Application.DisplayAlerts = True
  Application.EnableEvents = True
  Application.ScreenUpdating = True
  MsgBox "エラー: " & Err.Description, vbExclamation
End Sub

' ======================================================================
' 1行分の出力（統合名簿）
' - 役職が空白なら「審査官」
' - グループが空白なら「-」
' ======================================================================
Private Sub WriteOne(ByVal ws As Worksheet, ByVal r As Long, ByVal code As String, _
                     ByVal dictBoss As Object, ByVal dictRosterName As Object, ByVal dictMail As Object)

  Dim rec As Variant: rec = dictBoss(code)
  ' rec(1)=氏名, rec(2)=システム上の氏名, rec(3)=所属, rec(4)=グループ, rec(5)=役職

  Dim name As String: name = Nz(rec(1))
  Dim sysName As String: sysName = Nz(rec(2))
  Dim dept As String: dept = Nz(rec(3))
  Dim grp As String: grp = Nz(rec(4))
  Dim role As String: role = Nz(rec(5))

  ' 追加仕様：デフォルト値
  If Len(WorksheetFunction.Trim(role)) = 0 Then role = "審査官"
  If Len(WorksheetFunction.Trim(grp)) = 0 Then grp = "-"

  ' 名簿上の名前（氏名→名簿上の名前）
  Dim rosterName As String: rosterName = ""
  If dictRosterName.Exists(NormKey(name)) Then rosterName = Nz(dictRosterName(NormKey(name)))

  ' メール（システム上の氏名→メール）
  Dim mail As String: mail = ""
  If dictMail.Exists(NormKey(sysName)) Then mail = Nz(dictMail(NormKey(sysName)))

  ' 座席予約簿上の名前：名簿上の名前(所属)
  ' ※名簿上の名前が空なら氏名を代替（空欄回避）
  Dim baseSeat As String
  baseSeat = rosterName
  If Len(baseSeat) = 0 Then baseSeat = name

  Dim seatName As String
  If Len(baseSeat) = 0 Then
    seatName = ""
  ElseIf Len(dept) = 0 Then
    seatName = baseSeat
  Else
    seatName = baseSeat & "(" & dept & ")"
  End If

  ws.Cells(r, 1).Value = code
  ws.Cells(r, 2).Value = name
  ws.Cells(r, 3).Value = role
  ws.Cells(r, 4).Value = dept
  ws.Cells(r, 5).Value = grp
  ws.Cells(r, 6).Value = rosterName
  ws.Cells(r, 7).Value = seatName
  ws.Cells(r, 8).Value = sysName
  ws.Cells(r, 9).Value = mail
  ws.Cells(r, 10).Value = "" ' 特技懇（プルダウン）
End Sub

' ======================================================================
' 統合名簿：ヘッダーフィルタ（既存フィルタがあっても安全に付け直す）
' ======================================================================
Private Sub ApplyAutoFilterSafe(ByVal ws As Worksheet, ByVal headerRow As Long, ByVal colCount As Long, ByVal lastRow As Long)
  On Error Resume Next

  ' 既存のフィルタを解除
  If ws.AutoFilterMode Then ws.AutoFilterMode = False
  If ws.FilterMode Then ws.ShowAllData

  Dim rng As Range
  Set rng = ws.Range(ws.Cells(headerRow, 1), ws.Cells(Application.Max(headerRow + 1, lastRow), colCount))

  ' フィルタ付与（ヘッダー行＋データ範囲）
  rng.AutoFilter

  On Error GoTo 0
End Sub

' ======================================================================
' 【データなし判定】上司名簿に「コード」の実データ行があるか
' ======================================================================
Private Function HasBossData(ByVal ws As Worksheet) As Boolean
  Dim headerRow As Long: headerRow = FindHeaderRow(ws, Array("コード", "Code", "ID"))
  If headerRow = 0 Then
    HasBossData = False
    Exit Function
  End If

  Dim colCode As Long: colCode = FindColInRow(ws, headerRow, Array("コード", "Code", "ID"))
  If colCode = 0 Then
    HasBossData = False
    Exit Function
  End If

  Dim lastRow As Long: lastRow = LastUsedRow(ws)
  Dim r As Long
  For r = headerRow + 1 To lastRow
    If Len(NormCode(ws.Cells(r, colCode).Value)) > 0 Then
      HasBossData = True
      Exit Function
    End If
  Next r

  HasBossData = False
End Function

' ======================================================================
' テンプレ初期化（各シート：ヘッダー・枠・塗り等）
' ======================================================================
Private Sub InitTemplateBoss(ByVal ws As Worksheet)
  Dim headers As Variant
  headers = Array("氏名", "システム上の氏名", "所属", "グループ", "役職", "コード")

  If WorksheetFunction.CountA(ws.Rows(1)) = 0 Then
    ws.Range("A1").Resize(1, UBound(headers) + 1).Value = headers
  End If
  ApplyHeaderAndFrame ws, 1, UBound(headers) + 1, 200
End Sub

Private Sub InitTemplateOrder(ByVal ws As Worksheet)
  Dim headers As Variant
  headers = Array("名簿上の名前", "コード")

  If WorksheetFunction.CountA(ws.Rows(1)) = 0 Then
    ws.Range("A1").Resize(1, UBound(headers) + 1).Value = headers
  End If
  ApplyHeaderAndFrame ws, 1, UBound(headers) + 1, 300
End Sub

Private Sub InitTemplateMail(ByVal ws As Worksheet)
  Dim headers As Variant
  headers = Array("システム上の氏名", "メールアドレス")

  If WorksheetFunction.CountA(ws.Rows(1)) = 0 Then
    ws.Range("A1").Resize(1, UBound(headers) + 1).Value = headers
  End If
  ApplyHeaderAndFrame ws, 1, UBound(headers) + 1, 300
End Sub

Private Sub InitTemplateDisp(ByVal ws As Worksheet)
  Dim headers As Variant
  headers = Array("氏名", "名簿上の名前")

  If WorksheetFunction.CountA(ws.Rows(1)) = 0 Then
    ws.Range("A1").Resize(1, UBound(headers) + 1).Value = headers
  End If
  ApplyHeaderAndFrame ws, 1, UBound(headers) + 1, 300
End Sub

Private Sub InitTemplateOut(ByVal ws As Worksheet, ByVal headers As Variant)
  ws.Range("A1").Resize(1, UBound(headers) + 1).Value = headers
  ApplyHeaderAndFrame ws, 1, UBound(headers) + 1, 200

  ' 特技懇（〇×）はテンプレ範囲にもプルダウンを仕込む
  ApplyMaruBatsuDropdown ws, 2, 200, 10
End Sub

Private Sub ApplyHeaderAndFrame(ByVal ws As Worksheet, ByVal headerRow As Long, ByVal colCount As Long, ByVal templateRows As Long)
  BeautifyHeaderRow ws, headerRow, colCount

  Dim rng As Range
  Set rng = ws.Range(ws.Cells(1, 1), ws.Cells(templateRows, colCount))

  With rng.Borders
    .LineStyle = xlContinuous
    .Weight = xlThin
  End With

  ws.Rows(headerRow).RowHeight = 18
End Sub

' ======================================================================
' 上司名簿読み込み（コードキー）
' ======================================================================
Private Sub ReadBossRoster(ByVal ws As Worksheet, ByVal headerRow As Long, _
                           ByVal colCode As Long, ByVal colName As Long, ByVal colSys As Long, _
                           ByVal colDept As Long, ByVal colGroup As Long, ByVal colRole As Long, _
                           ByVal dictBoss As Object, ByVal codesInOrder As Collection)

  Dim lastRow As Long: lastRow = LastUsedRow(ws)
  Dim r As Long

  For r = headerRow + 1 To lastRow
    Dim code As String: code = NormCode(ws.Cells(r, colCode).Value)
    If Len(code) = 0 Then GoTo CONT

    Dim name As String: name = NormText(ws.Cells(r, colName).Value)
    Dim sysName As String: sysName = NormText(ws.Cells(r, colSys).Value)
    Dim dept As String: dept = NormText(ws.Cells(r, colDept).Value)
    Dim grp As String: grp = NormText(ws.Cells(r, colGroup).Value)
    Dim role As String: role = NormText(ws.Cells(r, colRole).Value)

    If Not dictBoss.Exists(code) Then
      Dim rec(1 To 5) As String
      rec(1) = name
      rec(2) = sysName
      rec(3) = dept
      rec(4) = grp
      rec(5) = role
      dictBoss.Add code, rec
      codesInOrder.Add code
    End If

CONT:
  Next r
End Sub

' ======================================================================
' 2列マップを読む（余計な人が混ざっていてもOK：左結合前提）
' ======================================================================
Private Sub ReadSimpleMap(ByVal ws As Worksheet, ByVal keyHeaders As Variant, ByVal valHeaders As Variant, _
                          ByVal dictOut As Object)

  Dim headerRow As Long: headerRow = FindAnyHeaderRow(ws, keyHeaders, valHeaders)
  If headerRow = 0 Then headerRow = 1

  Dim colKey As Long: colKey = FindColInRow(ws, headerRow, keyHeaders)
  Dim colVal As Long: colVal = FindColInRow(ws, headerRow, valHeaders)
  If colKey = 0 Or colVal = 0 Then Exit Sub

  Dim lastRow As Long: lastRow = LastUsedRow(ws)
  Dim r As Long

  For r = headerRow + 1 To lastRow
    Dim k As String: k = NormKey(ws.Cells(r, colKey).Value)
    If Len(k) = 0 Then GoTo CONT

    Dim v As String: v = NormText(ws.Cells(r, colVal).Value)
    If Len(v) = 0 Then GoTo CONT

    If Not dictOut.Exists(k) Then dictOut.Add k, v
CONT:
  Next r
End Sub

' ======================================================================
' 年次順シートから「上司名簿に存在するコード」だけを順序として抽出
' ======================================================================
Private Sub ReadOrderCodes(ByVal ws As Worksheet, ByVal dictBoss As Object, ByVal outCodes As Collection)
  Dim lastRow As Long: lastRow = LastUsedRow(ws)
  Dim lastCol As Long: lastCol = LastUsedCol(ws)
  If lastRow < 1 Or lastCol < 1 Then Exit Sub

  Dim seen As Object: Set seen = CreateObject("Scripting.Dictionary")

  Dim r As Long, c As Long
  For r = 1 To lastRow
    For c = 1 To Application.Min(lastCol, 5)
      Dim v As String: v = NormCode(ws.Cells(r, c).Value)
      If Len(v) > 0 Then
        If dictBoss.Exists(v) Then
          If Not seen.Exists(v) Then
            outCodes.Add v
            seen.Add v, True
          End If
        End If
      End If
    Next c
  Next r
End Sub

' ======================================================================
' 特技懇：〇/×プルダウン
' ======================================================================
Private Sub ApplyMaruBatsuDropdown(ByVal ws As Worksheet, ByVal rowFrom As Long, ByVal rowTo As Long, ByVal col As Long)
  If rowTo < rowFrom Then Exit Sub

  Dim rng As Range
  Set rng = ws.Range(ws.Cells(rowFrom, col), ws.Cells(rowTo, col))

  With rng.Validation
    .Delete
    .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, Operator:=xlBetween, Formula1:="〇,×"
    .IgnoreBlank = True
    .InCellDropdown = True
    .ShowError = True
  End With
End Sub

' ======================================================================
' 体裁：メイリオ10pt + 1行目固定（Freeze Panes）
' ======================================================================
Private Sub ApplyStandardSheetFormat(ByVal ws As Worksheet)
  With ws.Cells.Font
    .name = "メイリオ"
    .Size = 10
  End With

  On Error Resume Next
  ws.Activate
  ws.Range("A2").Select
  ActiveWindow.FreezePanes = False
  ActiveWindow.FreezePanes = True
  On Error GoTo 0
End Sub

Private Sub BeautifyHeaderRow(ByVal ws As Worksheet, ByVal headerRow As Long, ByVal colCount As Long)
  With ws.Range(ws.Cells(headerRow, 1), ws.Cells(headerRow, colCount))
    .Font.Bold = True
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
    .Interior.Color = RGB(242, 242, 242)
  End With
End Sub

' ======================================================================
' シート取得（なければ作成）
' ======================================================================
Private Function GetOrCreateSheet(ByVal wb As Workbook, ByVal name As String) As Worksheet
  On Error Resume Next
  Set GetOrCreateSheet = wb.Worksheets(name)
  On Error GoTo 0
  If GetOrCreateSheet Is Nothing Then
    Set GetOrCreateSheet = wb.Worksheets.Add(After:=wb.Worksheets(wb.Worksheets.Count))
    GetOrCreateSheet.name = name
  End If
End Function

' ======================================================================
' ヘッダー行検出
' ======================================================================
Private Function FindHeaderRow(ByVal ws As Worksheet, ByVal headerCandidates As Variant) As Long
  Dim r As Long, c As Long
  Dim lastRow As Long: lastRow = Application.Min(10, LastUsedRow(ws))
  Dim lastCol As Long: lastCol = Application.Min(200, LastUsedCol(ws))

  For r = 1 To lastRow
    For c = 1 To lastCol
      Dim t As String: t = NormHeader(ws.Cells(r, c).Value)
      If IsInCandidates(t, headerCandidates) Then
        FindHeaderRow = r
        Exit Function
      End If
    Next c
  Next r

  FindHeaderRow = 0
End Function

Private Function FindAnyHeaderRow(ByVal ws As Worksheet, ByVal keyHeaders As Variant, ByVal valHeaders As Variant) As Long
  Dim r As Long, c As Long
  Dim lastRow As Long: lastRow = Application.Min(10, LastUsedRow(ws))
  Dim lastCol As Long: lastCol = Application.Min(200, LastUsedCol(ws))

  For r = 1 To lastRow
    Dim hasKey As Boolean: hasKey = False
    Dim hasVal As Boolean: hasVal = False

    For c = 1 To lastCol
      Dim t As String: t = NormHeader(ws.Cells(r, c).Value)
      If IsInCandidates(t, keyHeaders) Then hasKey = True
      If IsInCandidates(t, valHeaders) Then hasVal = True
    Next c

    If hasKey And hasVal Then
      FindAnyHeaderRow = r
      Exit Function
    End If
  Next r

  FindAnyHeaderRow = 0
End Function

Private Function FindColInRow(ByVal ws As Worksheet, ByVal headerRow As Long, ByVal headerCandidates As Variant) As Long
  Dim lastCol As Long: lastCol = Application.Min(200, LastUsedCol(ws))
  Dim c As Long
  For c = 1 To lastCol
    Dim t As String: t = NormHeader(ws.Cells(headerRow, c).Value)
    If IsInCandidates(t, headerCandidates) Then
      FindColInRow = c
      Exit Function
    End If
  Next c
  FindColInRow = 0
End Function

Private Function IsInCandidates(ByVal text As String, ByVal candidates As Variant) As Boolean
  Dim i As Long
  For i = LBound(candidates) To UBound(candidates)
    If text = NormHeader(candidates(i)) Then
      IsInCandidates = True
      Exit Function
    End If
  Next i
  IsInCandidates = False
End Function

' ======================================================================
' 最終行/最終列
' ======================================================================
Private Function LastUsedRow(ByVal ws As Worksheet) As Long
  On Error Resume Next
  LastUsedRow = ws.Cells.Find(What:="*", LookIn:=xlFormulas, SearchOrder:=xlByRows, SearchDirection:=xlPrevious).Row
  If LastUsedRow = 0 Then LastUsedRow = 1
  On Error GoTo 0
End Function

Private Function LastUsedCol(ByVal ws As Worksheet) As Long
  On Error Resume Next
  LastUsedCol = ws.Cells.Find(What:="*", LookIn:=xlFormulas, SearchOrder:=xlByColumns, SearchDirection:=xlPrevious).Column
  If LastUsedCol = 0 Then LastUsedCol = 1
  On Error GoTo 0
End Function

' ======================================================================
' 正規化（比較用）
' ======================================================================
Private Function NormHeader(ByVal v As Variant) As String
  NormHeader = NormKey(v)
End Function

Private Function NormKey(ByVal v As Variant) As String
  Dim s As String: s = CStr(v)
  s = Replace(s, vbTab, " ")
  s = Replace(s, ChrW(&H3000), " ") ' 全角スペース
  s = WorksheetFunction.Trim(s)
  NormKey = s
End Function

Private Function NormText(ByVal v As Variant) As String
  NormText = NormKey(v)
End Function

Private Function NormCode(ByVal v As Variant) As String
  NormCode = NormKey(v) ' 先頭ゼロ保護のため文字列扱い
End Function

Private Function Nz(ByVal v As Variant) As String
  If IsError(v) Then
    Nz = ""
  ElseIf IsEmpty(v) Then
    Nz = ""
  Else
    Nz = CStr(v)
  End If
End Function


